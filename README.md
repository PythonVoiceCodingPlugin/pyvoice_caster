# Pyvoice Caster

These are the caster bindings for the [pyvoice project](ttps://github.com/PythonVoiceCodingPlugin/pyvoice)

<div>
<img src="https://github.com/PythonVoiceCodingPlugin/assets/blob/main/pyvoice_logo.png" align="right" height=320 width=320/>
</div>

<!-- MarkdownTOC  autolink="true" -->

- [Installation](#installation)
	- [Prerequisites](#prerequisites)
	- [Main steps](#main-steps)
- [Available commands](#available-commands)
	- [CCR \(chainable\) commands \(inserting expressions\)](#ccr-chainable-commands-inserting-expressions)
	- [Non CCR commands for \(imports machinery\)](#non-ccr-commands-for-imports-machinery)
- [Interprocess Communication: Troubleshooting and Security Considerations](#interprocess-communication-troubleshooting-and-security-considerations)
	- [Receiving speech hints](#receiving-speech-hints)
	- [Sending commands](#sending-commands)
		- [Sublime Text](#sublime-text)
		- [Vscode client](#vscode-client)
- [License](#license)

<!-- /MarkdownTOC -->


# Installation

## Prerequisites

You need to make sure you have some version >= 1.0.0 of [Caster](https://github.com/dictation-toolbox/Caster) installed

> [!WARNING]
> At the moment, no testing has been performed with the kaldi backend.

## Main steps

- navigate to your [caster user directory](https://caster.readthedocs.io/en/latest/readthedocs/User_Dir/Caster_User_Dir/)and then to the corresponding rules section. 

> [!IMPORTANT]
> There is a discrepancy in the directory structure between older and newer versions of caster. After to https://github.com/dictation-toolbox/Caster/pull/905 rules are placed under `caster_user_content\rules` ,whereas prior it should be simply `rules` Both should be supported

- clone this repo with git

```bash
git clone https://github.com/PythonVoiceCodingPlugin/pyvoice_caster.git
```

- reboot caster
- enable the two pyvoice grammars with the following ***voice commands***

	- `enable pyvoice CCR` - enables the pyvoice CCR grammar, this is a responsible for making expressions (like symbol names,  attributes of variables etc) that can be inserted via keyboard for  usage in your CCR chains.
	- `enable pyvoice import` - enables the pyvoice import grammar, this is primarily responsible for allowing you to import symbols

# Available commands

## CCR (chainable) commands (inserting expressions)

## Non CCR commands for (imports machinery)



# Interprocess Communication: Troubleshooting and Security Considerations

## Receiving speech hints

In order to transmit speech hints to the programming by voice system, an interprocess communication mechanism is employed utilizing `AF_UNIX` sockets on UNIX systems and `AF_PIPE` named pipes on Windows as transports with the format   being JSON-RPC 2.0. This caster grammar is going to bind that sockets or pipes as a listener/server and sublime/vscode are going to connects as a clients.

When booting up, if successfull you should see something like the following in the messages window

```
INFO:pyvoice_caster.rpc:Server for service default started at \\.\pipe\voicerpc\blablablabla\default
```

When the editor makes a connection and sends data you should see something like 

```
INFO:pyvoice_caster.dict_lists:Enhanced list expression with 126 items over 0.115 seconds (completed 2024-03-03 17:20:22.303000)
INFO:pyvoice_caster.dict_lists:Enhanced list importable with 1919 items over 3.019 seconds (completed 2024-03-03 17:20:25.176000)

```

> [!IMPORTANT]
> Implementation wise, the caster grammar is going to utilize the stdlib `multiprocessing.connection` machinery, it works cross-platform and cross python versions. Two important security-related notes
> - On Windows name pipe is created with the default security descriptors (per the stdlib). That means that nonprivileged users on that machine should be able to connect to the server launched by the grammar as readers (though given the one-way direction of the rpc mechanism, there should not be much to read anyhow) but they should not be able to write back to it(and execute commands). 
> - there exists a race condition where processes running with lower privileges may try to bind the named pipe on windows before our grammar does cuasing the editors to talk to them instead. In order to avoid the scenario, we utilize a mechanism of stdlib implementation   for authenticating both ends of the connection via cryptographic challenge based on a shared key. 
> The shared key is generated by the voice system and is persisted in json file in the user's home directory, which should be out of reach for those low privilege user processes. 


> [!WARNING]
> Unfortunately, the auth handshake employed by the stdlib is using HMAC-MD5. It is only python 3.12 that introduced support for stronger hash functions , while also extending the handshake protocol in a backwards compatible manner. While not the end of the world, at some point,I would have to back port the improved version

> [!NOTE]
> at the moment you cannot have multiple caster/talon grammars instances listening simultaneously

## Sending commands


### Sublime Text


Executing commands for sublime text is preformed via its commandline interface `subl` which may NOT always be in system path on all platforms by default.

The caster client will search through various directories based on your operating system in order to find its location. If this procedure fails, an error should appear in the logs. In that case please see the official sublime documentation for more information and submit an issue

https://www.sublimetext.com/docs/command_line.html


### Vscode client

commands are transmitted to vscode with file based RPC, with the [Command Server Extension](https://marketplace.visualstudio.com/items?itemName=pokey.command-server) acting as a receiver On the other end.

pokey had originally written a [python client for Talon](https://github.com/cursorless/cursorless-talon) which has also been incorporated into [community](https://github.com/talonhub/community/tree/main/apps/vscode/command_client) and which [termx88](https://github.com/termx88/cursorless-caster) has adapted for use with caster. Unfortunately, when I gave the implementation try,it could not run under python 2.7 as it included features from Python 3+, so I went around and tried to port it to python 2. In all honesty, I have cut a few corners too many to get it done quickly but in the limited testing I have performed the functionality was still there and did not appear to break the original talon client. However, keep an eye needs to be kept on this. 







# License

This project is licensed under the GPL v3 License - excluding the following bits

- `pyvoice_caster\vscode_client` which is adapted from [termx88](https://github.com/termx88/cursorless-caster) and which itself is adapted from [pokey's and the other cursorless folks work](https://github.com/cursorless/cursorless-talon) is licensed under the MIT
- `deps.zip` which packages for ease of installation the [`jsonrpc`](https://github.com/pavlov99/json-rpc/tree/master/jsonrpc) library (as dragonfly 1.0.0 is expected to no longer pull it as a dependency)  and is also licensed under MIT





